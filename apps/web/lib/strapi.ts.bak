import "server-only";

type FetchStrapiOptions = {
  locale?: string;
  revalidate?: number;
};

type StrapiListResponse<T> = {
  // Strapi v4: { id, attributes }
  // Strapi v5: { id, documentId, ...fields }
  data: Array<{ id: number; documentId?: string; attributes?: T } & Partial<T>>;
};

type StrapiSingleResponse<T> = {
  data: ({ id: number; documentId?: string; attributes?: T } & Partial<T>) | null;
};

function pickAttributes<T extends object>(item: { attributes?: T } & Partial<T>): T {
  return (item.attributes ?? (item as unknown as T)) as T;
}

const STRAPI_URL = process.env.STRAPI_URL;
const STRAPI_API_TOKEN = process.env.STRAPI_API_TOKEN;

export async function fetchStrapi(path: string, options: FetchStrapiOptions = {}) {
  if (!STRAPI_URL) {
    return null;
  }

  const url = new URL(path, STRAPI_URL);

  if (options.locale) {
    url.searchParams.set("locale", options.locale);
  }

  try {
    const response = await fetch(url.toString(), {
      headers: STRAPI_API_TOKEN
        ? {
            Authorization: `Bearer ${STRAPI_API_TOKEN}`,
          }
        : undefined,
      next: options.revalidate ? { revalidate: options.revalidate } : undefined,
    });

    if (!response.ok) {
      return null;
    }

    return response.json();
  } catch {
    return null;
  }
}

async function getCollection(locale: string, apiPath: string, revalidate = 300) {
  const data = (await fetchStrapi(apiPath, {
    locale,
    revalidate,
  })) as StrapiListResponse<{ slug?: string; title?: string; summary?: string }> | null;

  if (!data?.data?.length) return [];

  return data.data
    .map((item) => ({
      id: item.id,
      slug: pickAttributes(item).slug ?? "",
      title: pickAttributes(item).title ?? "Untitled",
      summary: pickAttributes(item).summary,
    }))
    .filter((item) => Boolean(item.slug));
}

async function getCollectionItemBySlug(locale: string, apiPath: string, slug: string, revalidate = 300) {
  const query = new URLSearchParams({
    "filters[slug][$eq]": slug,
  });

  const data = (await fetchStrapi(`${apiPath}?${query.toString()}`, {
    locale,
    revalidate,
  })) as StrapiListResponse<{ slug?: string; title?: string; summary?: string; body?: unknown; description?: string }> | null;

  const item = data?.data?.[0];
  if (!item) return null;

  const attrs = pickAttributes(item);

  return {
    id: item.id,
    slug: attrs.slug ?? slug,
    title: attrs.title ?? "Untitled",
    summary: attrs.summary ?? attrs.description ?? "",
    body: attrs.body ?? null,
  } as const;
}

type SiteSettingsAttributes = {
  title?: string;
  description?: string;
};

type DemoAttributes = {
  title?: string;
  slug?: string;
  summary?: string;
};

export async function getSiteSettings(locale: string) {
  // Strapi v5 single type route is typically singular.
  const data = (await fetchStrapi("/api/site-setting", {
    locale,
    revalidate: 60,
  })) as StrapiSingleResponse<SiteSettingsAttributes> | null;

  const item = data?.data;
  if (!item) return null;
  return pickAttributes(item);
}

export async function getDemos(locale: string) {
  const data = (await fetchStrapi("/api/demos", {
    locale,
    revalidate: 30,
  })) as StrapiListResponse<DemoAttributes> | null;

  if (!data?.data?.length) {
    return [];
  }

  return data.data.map((item) => ({
    id: item.id,
    title: pickAttributes(item).title ?? "Untitled Demo",
    slug: pickAttributes(item).slug ?? `demo-${item.id}`,
    summary: pickAttributes(item).summary ?? "",
  }));
}

export async function getDemoBySlug(locale: string, slug: string) {
  const query = new URLSearchParams({
    "filters[slug][$eq]": slug,
  });

  const data = (await fetchStrapi(`/api/demos?${query.toString()}`, {
    locale,
    revalidate: 30,
  })) as StrapiListResponse<DemoAttributes> | null;

  const item = data?.data?.[0];

  if (!item) {
    return null;
  }

  return {
    id: item.id,
    title: pickAttributes(item).title ?? "Untitled Demo",
    slug: pickAttributes(item).slug ?? slug,
    summary: pickAttributes(item).summary ?? "",
  };
}

export async function getSolutions(locale: string) {
  return getCollection(locale, "/api/solutions", 300);
}

export async function getSolutionBySlug(locale: string, slug: string) {
  return getCollectionItemBySlug(locale, "/api/solutions", slug, 300);
}

export async function getIndustries(locale: string) {
  return getCollection(locale, "/api/industries", 300);
}

export async function getIndustryBySlug(locale: string, slug: string) {
  return getCollectionItemBySlug(locale, "/api/industries", slug, 300);
}

export async function getCaseStudies(locale: string) {
  return getCollection(locale, "/api/case-studies", 300);
}

export async function getCaseStudyBySlug(locale: string, slug: string) {
  return getCollectionItemBySlug(locale, "/api/case-studies", slug, 300);
}

// ============================================================================
// NEW HOMEPAGE CONTENT TYPES
// ============================================================================

type HomepageAttributes = {
  heroTitle?: string;
  heroSubtitle?: string;
  heroPrimaryCta?: string;
  heroSecondaryCta?: string;
  heroBadge?: string;
  trustAward?: string;
  trustGlobal?: string;
  trustFast?: string;
  trustedByTitle?: string;
  howItWorksTitle?: string;
  howItWorksSubtitle?: string;
  featuresTitle?: string;
  featuresSubtitle?: string;
  solutionsTitle?: string;
  solutionsSubtitle?: string;
  ctaTitle?: string;
  ctaSubtitle?: string;
  ctaPrimaryButton?: string;
  ctaSecondaryButton?: string;
};

export async function getHomepage(locale: string) {
  const data = (await fetchStrapi("/api/homepage", {
    locale,
    revalidate: 60,
  })) as StrapiSingleResponse<HomepageAttributes> | null;

  const item = data?.data;
  if (!item) return null;
  return pickAttributes(item);
}

type StatAttributes = {
  value?: string;
  label?: string;
  order?: number;
};

export async function getStats(locale: string) {
  const data = (await fetchStrapi("/api/stats?sort=order:asc", {
    locale,
    revalidate: 300,
  })) as StrapiListResponse<StatAttributes> | null;

  if (!data?.data?.length) return [];

  return data.data.map((item) => ({
    id: item.id,
    value: pickAttributes(item).value ?? "0",
    label: pickAttributes(item).label ?? "",
    order: pickAttributes(item).order ?? 0,
  }));
}

type TrustedCompanyAttributes = {
  name?: string;
  order?: number;
};

export async function getTrustedCompanies(locale: string) {
  const data = (await fetchStrapi("/api/trusted-companies?sort=order:asc", {
    locale,
    revalidate: 300,
  })) as StrapiListResponse<TrustedCompanyAttributes> | null;

  if (!data?.data?.length) return [];

  return data.data.map((item) => ({
    id: item.id,
    name: pickAttributes(item).name ?? "",
    order: pickAttributes(item).order ?? 0,
  }));
}

type ProcessStepAttributes = {
  step?: number;
  title?: string;
  description?: string;
  icon?: string;
};

export async function getProcessSteps(locale: string) {
  const data = (await fetchStrapi("/api/process-steps?sort=step:asc", {
    locale,
    revalidate: 300,
  })) as StrapiListResponse<ProcessStepAttributes> | null;

  if (!data?.data?.length) return [];

  return data.data.map((item) => ({
    id: item.id,
    step: pickAttributes(item).step ?? 0,
    title: pickAttributes(item).title ?? "",
    description: pickAttributes(item).description ?? "",
    icon: pickAttributes(item).icon ?? "circle",
  }));
}

type FeatureAttributes = {
  title?: string;
  description?: string;
  icon?: string;
  order?: number;
};

export async function getFeatures(locale: string) {
  const data = (await fetchStrapi("/api/features?sort=order:asc", {
    locale,
    revalidate: 300,
  })) as StrapiListResponse<FeatureAttributes> | null;

  if (!data?.data?.length) return [];

  return data.data.map((item) => ({
    id: item.id,
    title: pickAttributes(item).title ?? "",
    description: pickAttributes(item).description ?? "",
    icon: pickAttributes(item).icon ?? "star",
    order: pickAttributes(item).order ?? 0,
  }));
}
